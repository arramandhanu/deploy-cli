# CPI-Food Deployment - GitHub Actions
#
# This workflow deploys services to production server.
# Trigger: Manual dispatch or push to main branch
#
# Required Secrets:
#   - DOCKERHUB_USERNAME: DockerHub username
#   - DOCKERHUB_PASSWORD: DockerHub access token
#   - SSH_PRIVATE_KEY: SSH private key for deployment
#   - REMOTE_HOST: Production server IP/hostname
#   - REMOTE_USER: SSH user for deployment

name: Deploy Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - admin-dashboard
          - keystore
          - landingpage
          - all
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        default: false
        type: boolean

  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'Dockerfile'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.service || 'auto' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Determine service to deploy
        id: service
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "service=${{ github.event.inputs.service }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            # Auto-detect based on changed files (customize as needed)
            echo "service=admin-dashboard" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Run deployment
        run: |
          chmod +x ./deploy.sh
          
          export SSH_KEY=~/.ssh/deploy_key
          export REMOTE_HOST=${{ secrets.REMOTE_HOST }}
          export REMOTE_USER=${{ secrets.REMOTE_USER }}
          
          ARGS="--yes"
          
          if [ "${{ steps.service.outputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            ARGS="$ARGS --env staging"
          fi
          
          SERVICE="${{ steps.service.outputs.service }}"
          if [ "$SERVICE" == "all" ]; then
            ARGS="$ARGS --all"
          else
            ARGS="$ARGS $SERVICE"
          fi
          
          ./deploy.sh $ARGS

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Service: ${{ steps.service.outputs.service }}"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Commit: ${{ github.sha }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."
