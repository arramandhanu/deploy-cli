# CPI-Food Deployment - Bitbucket Pipelines
#
# This pipeline deploys services to production server.
#
# Required Repository Variables (Repository Settings > Pipelines > Repository Variables):
#   - DOCKERHUB_USERNAME: DockerHub username
#   - DOCKERHUB_PASSWORD: DockerHub access token (secured)
#   - SSH_PRIVATE_KEY: SSH private key for deployment (secured)
#   - REMOTE_HOST: Production server IP/hostname
#   - REMOTE_USER: SSH user for deployment

image: docker:24-dind

definitions:
  services:
    docker:
      memory: 2048

  steps:
    - step: &deploy-step
        name: Deploy Service
        services:
          - docker
        script:
          # Install dependencies
          - apk add --no-cache openssh-client bash git
          
          # Setup SSH
          - mkdir -p ~/.ssh
          - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          - chmod 600 ~/.ssh/deploy_key
          - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
          
          # Docker login
          - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          
          # Run deployment
          - chmod +x ./deploy.sh
          - export SSH_KEY=~/.ssh/deploy_key
          - ./deploy.sh ${SERVICE} --yes --env ${ENVIRONMENT}

pipelines:
  # Manual deployments via custom pipelines
  custom:
    deploy-admin-dashboard-production:
      - step:
          <<: *deploy-step
          name: Deploy Admin Dashboard to Production
          deployment: production
          script:
            - apk add --no-cache openssh-client bash git
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./deploy.sh
            - export SSH_KEY=~/.ssh/deploy_key
            - ./deploy.sh admin-dashboard --yes --env production

    deploy-keystore-production:
      - step:
          <<: *deploy-step
          name: Deploy Keystore to Production
          deployment: production
          script:
            - apk add --no-cache openssh-client bash git
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./deploy.sh
            - export SSH_KEY=~/.ssh/deploy_key
            - ./deploy.sh keystore --yes --env production

    deploy-landingpage-production:
      - step:
          <<: *deploy-step
          name: Deploy Landing Page to Production
          deployment: production
          script:
            - apk add --no-cache openssh-client bash git
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./deploy.sh
            - export SSH_KEY=~/.ssh/deploy_key
            - ./deploy.sh landingpage --yes --env production

    deploy-all-production:
      - step:
          <<: *deploy-step
          name: Deploy All Services to Production
          deployment: production
          script:
            - apk add --no-cache openssh-client bash git
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./deploy.sh
            - export SSH_KEY=~/.ssh/deploy_key
            - ./deploy.sh --all --yes --env production

    dry-run:
      - step:
          name: Dry Run Test
          services:
            - docker
          script:
            - apk add --no-cache bash git
            - chmod +x ./deploy.sh
            - ./deploy.sh admin-dashboard --dry-run

  # Auto-deploy on branch pushes
  branches:
    main:
      - step:
          name: Build Check
          script:
            - apk add --no-cache bash git
            - chmod +x ./deploy.sh
            - ./deploy.sh --list
            - echo "Ready for deployment. Use custom pipeline to deploy."

    develop:
      - step:
          <<: *deploy-step
          name: Deploy to Staging
          deployment: staging
          script:
            - apk add --no-cache openssh-client bash git
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./deploy.sh
            - export SSH_KEY=~/.ssh/deploy_key
            - ./deploy.sh admin-dashboard --yes --env staging
